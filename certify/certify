#!/bin/bash

strDate=$(date +%Y-%m-%d)

strCertifyBaseFolder=/etc/certify

strCertifyConfigFolder=$strCertifyBaseFolder/configs
strCertifyDefaultConfig=$strCertifyConfigFolder/foo.bar.conf
strNginxConfigPath=/etc/nginx/conf.d
strExampleDomainName=example.org

strCertifyDomainFolder=$strCertifyBaseFolder/domains
strCertifyLogFolder=$strCertifyBaseFolder/log
strCertifyLogFinalPath=$strCertifyLogFolder/certify_$strDate.log

function Logger() {

    if [ ! -f $strCertifyLogFinalPath ]; then
        touch $strCertifyLogFinalPath
    fi 

    echo -e "$strDate || $1" >> $strCertifyLogFinalPath

}

function init() {
    echo "init"
}

function ReloadNginxService() {
    /etc/init.d/nginx reload
}

function RegisterCertificate() {
    strDomainName=$1
    strMailAddress=$2
    strCertbotWebDir=/var/www/certbot/$strDomainName

    mkdir -p $strCertbotWebDir
    chown -R nginx:nginx /var/www/

    strDefaultNginxConfig=/etc/nginx/conf.d/80-default.conf
    strOriginString=/var/www/certbot
    strNewString=/var/www/certbot/$strDomainName

    sed -i "s#$strOriginString#$strNewString#g" $strDefaultNginxConfig

    /etc/init.d/nginx reload > /dev/null 2>&1

    certbot certonly -n --webroot --webroot-path=$strCertbotWebDir -m $strMailAddress --agree-tos -d $strDomainName

    sed -i "s#$strNewString#$strOriginString#g" $strDefaultNginxConfig

    /etc/init.d/nginx reload > /dev/null 2>&1

    cp $strCertifyDefaultConfig $strNginxConfigPath/$strDomainName

    sed -i 's/'$strExampleDomainName'/'$strDomainName'/g' $strNginxConfigPath/$strDomainName

    mv $strNginxConfigPath/$strDomainName $strNginxConfigPath/$strDomainName.conf

    /etc/init.d/nginx reload > /dev/null 2>&1
}

case "$1" in
        "--newcert" )
        RegisterCertificate $2 $3
        ;;
        *) 
        echo "Invalid Option"
        exit 1
        ;;
   esac

exit 0